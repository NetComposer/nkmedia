# ROOM Plugin

This plugin allows you to manage SFU or MCUs rooms easily. All backends use it when performing actions like publishing or listening. See also the [nkmedia_msglog plugin](room_msglog.md).


* [**Commands**](#commands)
  * [`create`](#create): Create a new room
  * [`destroy`](#destroy): Destroys a room
  * [`get_list`](#get_list): List known rooms
  * [`get_info`](#get_info): Gets information about a room
* [**Events**](#events)

All commands must have 

```js
{
  class: "media",
  subclass: "room"
}
```

See also each backend documentation:

* [nkmedia_janus](janus.md)
* [nkmedia_fs](fs.md)
* [nkmedia_kms](kms.md)

Also, for Erlang developers, you can have a look at the command [syntax specification](../src/nkmedia_room_api_syntax.erl) and [command implementation](../src/nkmedia_room_api.erl).


# Commands

## create

When creating a room, you can supply a name or allow NkMEDIA to generate a random new one. 

Then mandatory supported `class` must be:

* sfu: Supported by [nkmedia_janus](janus.md) and [nkmedia_kms](kms.md) SFU session types.
* mcu: Supported by [nkmedia_fs](fs.md) MCU session types (TBD)

The supported options are:

Field|Default|Description
---|---|---|---
class|(mandatory)|Room class
room_id|(automatic)|Room Id (will be autogenerated if not included)
backend|(automatic)|Forces a specific backend for the room
audio_codec|"opus"|Supported by Janus
video_codec|"vp8"|Supported by Janus
bitrate|0|Supported by Janus


**Sample**

 ```js
{
	class: "media",
  	subclass: "room",
  	cmd: "create",
  	data: {
    	class: "sfu",
    	video_codec: "vp9"
  },
  tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: {
    	room_id: "4611e276-3919-9683-0bae-38c9862f00d9"
    },
    tid: 1
}
```


## destroy

Destroys a started room. Current participant sessions, if any, will be removed.

**Sample**

 ```js
{
	class: "media",
  	subclass: "room",
  	cmd: "destroy",
  	data: {
    	room_id: "4611e276-3919-9683-0bae-38c9862f00d9"
  	},
  	tid: 1
}
```


## get_list

Gets a list of known rooms, along with its class

**Sample**

 ```js
{
	class: "media",
  	subclass: "room",
  	cmd: "get_list",
    tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: [
	    {
	      class: "sfu",
	      room_id: "002f5758-3919-9408-4a02-38c9862f00d9"
	    },
	    {
	      class: "sfu",
	      room_id: "8a87bfc2-3919-9161-b1ab-38c9862f00d9"
	    }
  	],
    tid: 1
}
```


## get_info

Gets information about a started room, along with the list of members.


**Sample**

 ```js
{
	class: "media",
  	subclass: "room",
  	cmd: "get_info",
  	data: {
  		room_id: "002f5758-3919-9408-4a02-38c9862f00d9"
  	},
    tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: {
		class: "sfu",
		backend: "nkmedia_janus",
    members: {
  		"0737dc33-391a-2700-1470-38c9862f00d9": {
            role: "listener"
    		peer_id: "39ce4076-391a-1260-75db-38c9862f00d9",
    		user_id: "listener1@domain.com"
      },
      "39ce4076-391a-1260-75db-38c9862f00d9": {
            role: "publisher",
            user_id: "1009"
      },
      "90076c74-391a-153c-f6c7-38c9862f00d9": {
            role: "publisher",
            user_id: "1008"
      }
    },
    tid: 1
}
```

# Events

You can subscribe to receive room events, as described in the NkService documentation.

All room generated events will follow the pattern:

```js
{
  class: "core",
  cmd: "event",
  data: {
    class: "media",
    subclass: "room",
    type: "...",
    obj_id: "...",
    body: {
      ...
    }
  },
  tid: 1
}
```

The `obj_id` field will match the _room id_, and the following types are supported: 


Type|Body|Description
---|---|---
created|`{class: ..., backend: ...}`|Fired when a new room is created
destroyed|`{code: ..., reason: ...}`|A room has been destroyed
started_member|`{session_id: ..., role: ... user_id: ...}`|Fired when a new members joins the room
stopped_member|`{session_id: ..., role: ..., user_id: ...}`|An existing member is leaving the room

