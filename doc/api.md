# NkMEDIA Management API

## Introduction

NkMEDIA offers a management interface over WS or WSS connections. Using this interface, you can create sessions, set offers and answers and any supported operation. You can also access specific information about the NkMEDIA engine and the started backends. 

All mensajes over the management interface are JSON messages with the following fields:

Field|Sample|Comment
---|---|---
class|"nkmedia"|This field must always be sent to "nkmedia".
cmd|"start_session"|Invoques an operation at the server. See bellow.
data|"{}"|Allows to supply specific parameters for each cmd. Optional.
tid|46481|Each request must have an unique transaction id (any numerical or text value)

All mensajes must be answered with a response having the following fields:

Field|Sample|Comment
---|---|---
result|"ok"|Each cmd can generate a set of specific answers. See bellow.
data|"{}"|Allows to supply specific parameters on the response. Optional.
tid|46481|Must match the "tid" in the request

Success responses will typically have `"result": "ok"`. Error responses will typically follow the following structure:

```json
{
	“result”: “error”,
	“data”: {
		“error”: "Error Text",
		“code”: 1234
	}
}
```


Responses are expected to be sent inmediately. If a reply is not available withing 1-2 seconds, the called party must send an ack, with the following sructure:

```json
{
	"ack": 46481
}
```

NkMEDIA will close the connection if no response is received in 5 seconds. Sending an ACK will extend this period to 3 minutes. NkMEDIA server will also send periodic ping requets.

## Login process

Right after starting the connection, the client must send a "login" request (see bellow). 

NkMEDIA works by starting one or more _services_. Each service can listen on specific ports and have a set of backends and functionalities. Services can be started in two ways:
* Defining them in NkMEDIA configuration file
* Starting them on demand using the management interface

To create a service programatically, you must log in to the "core" service. Once a service is created and active, you can log in to it. 

Example of loggin to the core service:

```json
{
	"class": "nkmedia",
	"cmd": "login",
	"data": {
		"service": "core",
		"pass": "pass"
	},
	"tid": 1
}
```

and the server would reply:
```json
{
	"result": "ok",
	"tid": 1
}
```

## Subscriptions

Clients using the management interface can subscribe to events generated by core NkMEDIA services or any backend or plugin capable of generating events.
See the documentation bellow to find specific events. You can subscribe for events for all services (if you login to the 'core' service) or specific for your service (if you login to it). You must subscribe to a specific class, and optionally, subclass of events.

For example:

```json
{
	"class": "nkmedia",
	"cmd": "subscribe",
	"data": {
		"target": "core",
		"class": "hangup"
	},
	"tid": 1
}
```

or 

```json
{
	"class": "nkmedia",
	"cmd": "subscribe",
	"data": {
		"plugin": "nkmedia_janus",
		"class": "room",
		"subclass": ["create", "delete"]
	},
	"tid": 1
}
```

## Multiple connections

You can start multiple connections to NkMEDIA, even for the same service, in order to distribute the load or provide high availability for your application.
Subscriptions are shared among all connections to the same service. When an event is available, NkMEDIA will send it to only one of the connections. If it fails it would try again with another one.














